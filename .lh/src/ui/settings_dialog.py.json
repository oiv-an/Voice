{
    "sourceFile": "src/ui/settings_dialog.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 3,
            "patches": [
                {
                    "date": 1764295798557,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764296277811,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,15 +3,15 @@\n from dataclasses import replace\r\n from typing import Optional\r\n \r\n from PyQt6.QtCore import Qt\r\n+from PyQt6.QtGui import QPalette, QColor\r\n from PyQt6.QtWidgets import (\r\n     QComboBox,\r\n     QDialog,\r\n     QDialogButtonBox,\r\n     QFormLayout,\r\n     QGridLayout,\r\n-    QHBoxLayout,\r\n     QLabel,\r\n     QLineEdit,\r\n     QVBoxLayout,\r\n     QWidget,\r\n@@ -42,8 +42,9 @@\n         self._result_settings: Optional[AppSettings] = None\r\n \r\n         self._init_ui()\r\n         self._load_from_settings(settings)\r\n+        self._apply_palette()\r\n \r\n     # ------------------------------------------------------------------ public API\r\n \r\n     def get_result(self) -> Optional[AppSettings]:\r\n@@ -59,34 +60,40 @@\n         layout = QVBoxLayout(self)\r\n \r\n         # --- Backend selection\r\n         backend_layout = QFormLayout()\r\n+        self.backend_label = QLabel(\"Сервис распознавания:\")\r\n         self.backend_combo = QComboBox()\r\n         self.backend_combo.addItem(\"Groq\", userData=\"groq\")\r\n         self.backend_combo.addItem(\"OpenAI\", userData=\"openai\")\r\n         self.backend_combo.currentIndexChanged.connect(self._on_backend_changed)\r\n-        backend_layout.addRow(\"Сервис распознавания:\", self.backend_combo)\r\n+        backend_layout.addRow(self.backend_label, self.backend_combo)\r\n \r\n         layout.addLayout(backend_layout)\r\n \r\n-        # --- Stacked area for backend-specific settings\r\n+        # --- Backend-specific settings\r\n         self.backend_widget = QWidget()\r\n         backend_grid = QGridLayout(self.backend_widget)\r\n         backend_grid.setColumnStretch(1, 1)\r\n \r\n         # Groq controls\r\n+        self.groq_label = QLabel(\"Groq API key:\")\r\n         self.groq_api_key_edit = QLineEdit()\r\n         self.groq_api_key_edit.setEchoMode(QLineEdit.EchoMode.Password)\r\n-        backend_grid.addWidget(QLabel(\"Groq API key:\"), 0, 0)\r\n+        backend_grid.addWidget(self.groq_label, 0, 0)\r\n         backend_grid.addWidget(self.groq_api_key_edit, 0, 1)\r\n \r\n         # OpenAI controls\r\n+        self.openai_key_label = QLabel(\"OpenAI API key:\")\r\n         self.openai_api_key_edit = QLineEdit()\r\n         self.openai_api_key_edit.setEchoMode(QLineEdit.EchoMode.Password)\r\n+\r\n+        self.openai_url_label = QLabel(\"OpenAI Base URL:\")\r\n         self.openai_base_url_edit = QLineEdit()\r\n-        backend_grid.addWidget(QLabel(\"OpenAI API key:\"), 1, 0)\r\n+\r\n+        backend_grid.addWidget(self.openai_key_label, 1, 0)\r\n         backend_grid.addWidget(self.openai_api_key_edit, 1, 1)\r\n-        backend_grid.addWidget(QLabel(\"OpenAI Base URL:\"), 2, 0)\r\n+        backend_grid.addWidget(self.openai_url_label, 2, 0)\r\n         backend_grid.addWidget(self.openai_base_url_edit, 2, 1)\r\n \r\n         layout.addWidget(self.backend_widget)\r\n \r\n"
                },
                {
                    "date": 1764296384555,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,8 +43,9 @@\n \r\n         self._init_ui()\r\n         self._load_from_settings(settings)\r\n         self._apply_palette()\r\n+        self._apply_palette()\r\n \r\n     # ------------------------------------------------------------------ public API\r\n \r\n     def get_result(self) -> Optional[AppSettings]:\r\n"
                },
                {
                    "date": 1764296453707,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -42,10 +42,9 @@\n         self._result_settings: Optional[AppSettings] = None\r\n \r\n         self._init_ui()\r\n         self._load_from_settings(settings)\r\n-        self._apply_palette()\r\n-        self._apply_palette()\r\n+        # палитру пока не трогаем, чтобы не падать; вернёмся к этому позже\r\n \r\n     # ------------------------------------------------------------------ public API\r\n \r\n     def get_result(self) -> Optional[AppSettings]:\r\n@@ -180,13 +179,12 @@\n         is_openai = backend == \"openai\"\r\n \r\n         # Groq: только поле API key\r\n         self.groq_api_key_edit.setVisible(is_groq)\r\n+\r\n         # OpenAI: API key + Base URL\r\n         self.openai_api_key_edit.setVisible(is_openai)\r\n         self.openai_base_url_edit.setVisible(is_openai)\r\n \r\n-        # Подписи остаются, но можно было бы тоже скрывать при желании\r\n-\r\n     def _on_accept(self) -> None:\r\n         self._result_settings = self._build_new_settings()\r\n         self.accept()\n\\ No newline at end of file\n"
                }
            ],
            "date": 1764295798557,
            "name": "Commit-0",
            "content": "from __future__ import annotations\r\n\r\nfrom dataclasses import replace\r\nfrom typing import Optional\r\n\r\nfrom PyQt6.QtCore import Qt\r\nfrom PyQt6.QtWidgets import (\r\n    QComboBox,\r\n    QDialog,\r\n    QDialogButtonBox,\r\n    QFormLayout,\r\n    QGridLayout,\r\n    QHBoxLayout,\r\n    QLabel,\r\n    QLineEdit,\r\n    QVBoxLayout,\r\n    QWidget,\r\n)\r\n\r\nfrom config.settings import AppSettings, RecognitionConfig\r\n\r\n\r\nclass SettingsDialog(QDialog):\r\n    \"\"\"\r\n    Простое окно настроек для выбора backend'а распознавания и ввода ключей/URL.\r\n\r\n    Что есть:\r\n    - Выпадающий список backend'ов: Groq / OpenAI.\r\n    - Для Groq: поле API key.\r\n    - Для OpenAI: поля API key и Base URL.\r\n    - Кнопки OK / Cancel.\r\n\r\n    Диалог работает поверх текущего AppSettings и возвращает обновлённый\r\n    экземпляр настроек через метод get_result().\r\n    \"\"\"\r\n\r\n    def __init__(self, settings: AppSettings, parent: Optional[QWidget] = None) -> None:\r\n        super().__init__(parent)\r\n        self.setWindowTitle(\"Настройки\")\r\n        self.setModal(True)\r\n        self._original_settings = settings\r\n        self._result_settings: Optional[AppSettings] = None\r\n\r\n        self._init_ui()\r\n        self._load_from_settings(settings)\r\n\r\n    # ------------------------------------------------------------------ public API\r\n\r\n    def get_result(self) -> Optional[AppSettings]:\r\n        \"\"\"\r\n        Возвращает новый экземпляр AppSettings, если пользователь нажал OK,\r\n        иначе None.\r\n        \"\"\"\r\n        return self._result_settings\r\n\r\n    # ------------------------------------------------------------------ UI\r\n\r\n    def _init_ui(self) -> None:\r\n        layout = QVBoxLayout(self)\r\n\r\n        # --- Backend selection\r\n        backend_layout = QFormLayout()\r\n        self.backend_combo = QComboBox()\r\n        self.backend_combo.addItem(\"Groq\", userData=\"groq\")\r\n        self.backend_combo.addItem(\"OpenAI\", userData=\"openai\")\r\n        self.backend_combo.currentIndexChanged.connect(self._on_backend_changed)\r\n        backend_layout.addRow(\"Сервис распознавания:\", self.backend_combo)\r\n\r\n        layout.addLayout(backend_layout)\r\n\r\n        # --- Stacked area for backend-specific settings\r\n        self.backend_widget = QWidget()\r\n        backend_grid = QGridLayout(self.backend_widget)\r\n        backend_grid.setColumnStretch(1, 1)\r\n\r\n        # Groq controls\r\n        self.groq_api_key_edit = QLineEdit()\r\n        self.groq_api_key_edit.setEchoMode(QLineEdit.EchoMode.Password)\r\n        backend_grid.addWidget(QLabel(\"Groq API key:\"), 0, 0)\r\n        backend_grid.addWidget(self.groq_api_key_edit, 0, 1)\r\n\r\n        # OpenAI controls\r\n        self.openai_api_key_edit = QLineEdit()\r\n        self.openai_api_key_edit.setEchoMode(QLineEdit.EchoMode.Password)\r\n        self.openai_base_url_edit = QLineEdit()\r\n        backend_grid.addWidget(QLabel(\"OpenAI API key:\"), 1, 0)\r\n        backend_grid.addWidget(self.openai_api_key_edit, 1, 1)\r\n        backend_grid.addWidget(QLabel(\"OpenAI Base URL:\"), 2, 0)\r\n        backend_grid.addWidget(self.openai_base_url_edit, 2, 1)\r\n\r\n        layout.addWidget(self.backend_widget)\r\n\r\n        # --- Buttons\r\n        buttons = QDialogButtonBox(\r\n            QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel\r\n        )\r\n        buttons.accepted.connect(self._on_accept)\r\n        buttons.rejected.connect(self.reject)\r\n\r\n        layout.addWidget(buttons)\r\n\r\n        self.setLayout(layout)\r\n        self.setMinimumWidth(420)\r\n\r\n    # ------------------------------------------------------------------ load/save\r\n\r\n    def _load_from_settings(self, settings: AppSettings) -> None:\r\n        rec: RecognitionConfig = settings.recognition\r\n\r\n        # backend\r\n        backend = rec.backend.lower()\r\n        if backend == \"groq\":\r\n            index = self.backend_combo.findData(\"groq\")\r\n        elif backend == \"openai\":\r\n            index = self.backend_combo.findData(\"openai\")\r\n        else:\r\n            # по умолчанию groq\r\n            index = self.backend_combo.findData(\"groq\")\r\n        if index != -1:\r\n            self.backend_combo.setCurrentIndex(index)\r\n\r\n        # groq\r\n        self.groq_api_key_edit.setText(rec.groq.api_key)\r\n\r\n        # openai\r\n        self.openai_api_key_edit.setText(rec.openai.api_key)\r\n        self.openai_base_url_edit.setText(rec.openai.base_url)\r\n\r\n        # применить видимость полей\r\n        self._on_backend_changed()\r\n\r\n    def _build_new_settings(self) -> AppSettings:\r\n        \"\"\"\r\n        Создаёт новый экземпляр AppSettings на основе текущих значений в диалоге.\r\n        \"\"\"\r\n        backend_data = self.backend_combo.currentData()\r\n        backend = str(backend_data) if backend_data is not None else \"groq\"\r\n\r\n        old = self._original_settings\r\n\r\n        # Обновляем recognition-конфиг\r\n        new_recognition = RecognitionConfig(\r\n            backend=backend,\r\n            local=old.recognition.local,\r\n            openai=replace(\r\n                old.recognition.openai,\r\n                api_key=self.openai_api_key_edit.text().strip(),\r\n                base_url=self.openai_base_url_edit.text().strip(),\r\n            ),\r\n            groq=replace(\r\n                old.recognition.groq,\r\n                api_key=self.groq_api_key_edit.text().strip(),\r\n            ),\r\n        )\r\n\r\n        new_settings = replace(\r\n            old,\r\n            recognition=new_recognition,\r\n        )\r\n        return new_settings\r\n\r\n    # ------------------------------------------------------------------ slots\r\n\r\n    def _on_backend_changed(self) -> None:\r\n        \"\"\"\r\n        Показываем/скрываем поля в зависимости от выбранного backend'а.\r\n        \"\"\"\r\n        backend_data = self.backend_combo.currentData()\r\n        backend = str(backend_data) if backend_data is not None else \"groq\"\r\n\r\n        is_groq = backend == \"groq\"\r\n        is_openai = backend == \"openai\"\r\n\r\n        # Groq: только поле API key\r\n        self.groq_api_key_edit.setVisible(is_groq)\r\n        # OpenAI: API key + Base URL\r\n        self.openai_api_key_edit.setVisible(is_openai)\r\n        self.openai_base_url_edit.setVisible(is_openai)\r\n\r\n        # Подписи остаются, но можно было бы тоже скрывать при желании\r\n\r\n    def _on_accept(self) -> None:\r\n        self._result_settings = self._build_new_settings()\r\n        self.accept()"
        }
    ]
}