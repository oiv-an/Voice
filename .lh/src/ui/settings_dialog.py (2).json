{
    "sourceFile": "src/ui/settings_dialog.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1764628107532,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764647649725,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -131,19 +131,12 @@\n \r\n         self.openai_asr_model_edit = QLineEdit()\r\n         asr_form.addRow(\"OpenAI ASR model:\", self.openai_asr_model_edit)\r\n \r\n-        # Локальный GigaAM-v3 (модель и HF‑токен)\r\n+        # Локальный GigaAM-v3 (модель)\r\n         self.gigaam_model_edit = QLineEdit()\r\n         asr_form.addRow(\"GigaAM-v3 local model:\", self.gigaam_model_edit)\r\n \r\n-        self.gigaam_hf_token_edit = QLineEdit()\r\n-        self.gigaam_hf_token_edit.setEchoMode(QLineEdit.EchoMode.Password)\r\n-        self.gigaam_hf_token_edit.setPlaceholderText(\r\n-            \"Hugging Face token для GigaAM‑v3 (нужен для длинных записей)\"\r\n-        )\r\n-        asr_form.addRow(\"HF token (GigaAM):\", self.gigaam_hf_token_edit)\r\n-\r\n         layout.addWidget(asr_group)\r\n \r\n         # === Блок: постобработка (LLM) =========================================\r\n         post_group = QGroupBox(\"Постобработка текста (LLM)\")\r\n"
                },
                {
                    "date": 1764647680784,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -192,9 +192,8 @@\n         # ASR‑модели\r\n         self.groq_asr_model_edit.setText(rec.groq.model)\r\n         self.openai_asr_model_edit.setText(rec.openai.model)\r\n         self.gigaam_model_edit.setText(rec.local.model)\r\n-        self.gigaam_hf_token_edit.setText(getattr(rec.local, \"hf_token\", \"\") or \"\")\r\n \r\n         # LLM‑модели (постпроцессинг)\r\n         self.post_enabled_checkbox.setChecked(settings.postprocess.enabled)\r\n \r\n@@ -239,9 +238,8 @@\n             backend=backend,\r\n             local=replace(\r\n                 old.recognition.local,\r\n                 model=(self.gigaam_model_edit.text().strip() or old.recognition.local.model),\r\n-                hf_token=self.gigaam_hf_token_edit.text().strip(),\r\n             ),\r\n             openai=replace(\r\n                 old.recognition.openai,\r\n                 api_key=self.openai_api_key_edit.text().strip(),\r\n"
                }
            ],
            "date": 1764628107532,
            "name": "Commit-0",
            "content": "from __future__ import annotations\r\n\r\nfrom dataclasses import replace\r\nfrom typing import Optional\r\n\r\nfrom PyQt6.QtWidgets import (\r\n    QCheckBox,\r\n    QComboBox,\r\n    QDialog,\r\n    QDialogButtonBox,\r\n    QFormLayout,\r\n    QGroupBox,\r\n    QLabel,\r\n    QLineEdit,\r\n    QVBoxLayout,\r\n    QWidget,\r\n)\r\n\r\nfrom config.settings import AppSettings, RecognitionConfig\r\n\r\n\r\nclass SettingsDialog(QDialog):\r\n    \"\"\"\r\n    Окно настроек распознавания и постобработки.\r\n\r\n    Блоки:\r\n    - Сервис распознавания (Groq / OpenAI) + ключи / Base URL.\r\n    - Модели распознавания (ASR) для Groq и OpenAI.\r\n    - Постобработка (LLM) + модели Groq/OpenAI для коррекции текста.\r\n    \"\"\"\r\n\r\n    def __init__(self, settings: AppSettings, parent: Optional[QWidget] = None) -> None:\r\n        super().__init__(parent)\r\n        self.setWindowTitle(\"Настройки\")\r\n        self.setModal(True)\r\n        self._original_settings = settings\r\n        self._result_settings: Optional[AppSettings] = None\r\n\r\n        self._init_ui()\r\n        self._load_from_settings(settings)\r\n\r\n    # ------------------------------------------------------------------ public API\r\n\r\n    def get_result(self) -> Optional[AppSettings]:\r\n        return self._result_settings\r\n\r\n    # ------------------------------------------------------------------ UI\r\n\r\n    def _init_ui(self) -> None:\r\n        layout = QVBoxLayout(self)\r\n\r\n        # Сделать текст и подписи более контрастными\r\n        self.setStyleSheet(\r\n            \"\"\"\r\n            QDialog {\r\n                background-color: #2b2b2b;\r\n                color: #f0f0f0;\r\n            }\r\n            QGroupBox {\r\n                color: #f0f0f0;\r\n                font-weight: bold;\r\n                border: 1px solid #555555;\r\n                border-radius: 4px;\r\n                margin-top: 8px;\r\n            }\r\n            QGroupBox::title {\r\n                subcontrol-origin: margin;\r\n                left: 8px;\r\n                padding: 0 4px;\r\n            }\r\n            QLabel {\r\n                color: #f0f0f0;\r\n            }\r\n            QLineEdit {\r\n                background-color: #3a3a3a;\r\n                color: #ffffff;\r\n                border: 1px solid #666666;\r\n                border-radius: 3px;\r\n                padding: 2px 4px;\r\n            }\r\n            QLineEdit:disabled {\r\n                background-color: #444444;\r\n                color: #aaaaaa;\r\n            }\r\n            QCheckBox {\r\n                color: #f0f0f0;\r\n            }\r\n            QComboBox {\r\n                background-color: #3a3a3a;\r\n                color: #ffffff;\r\n                border: 1px solid #666666;\r\n                border-radius: 3px;\r\n                padding: 2px 4px;\r\n            }\r\n            QDialogButtonBox QPushButton {\r\n                min-width: 70px;\r\n            }\r\n            \"\"\"\r\n        )\r\n\r\n        # === Блок: сервис распознавания (backend + ключи) ======================\r\n        backend_group = QGroupBox(\"Сервис распознавания\")\r\n        backend_form = QFormLayout(backend_group)\r\n\r\n        self.backend_combo = QComboBox()\r\n        self.backend_combo.addItem(\"Groq\", userData=\"groq\")\r\n        self.backend_combo.addItem(\"OpenAI\", userData=\"openai\")\r\n        self.backend_combo.addItem(\"GigaAM-v3 (local)\", userData=\"local\")\r\n        # выбор сервиса распознавания ничего не скрывает, сигнал больше не нужен\r\n        backend_form.addRow(\"Сервис распознавания:\", self.backend_combo)\r\n\r\n        self.groq_api_key_edit = QLineEdit()\r\n        self.groq_api_key_edit.setEchoMode(QLineEdit.EchoMode.Password)\r\n        backend_form.addRow(\"Groq API key:\", self.groq_api_key_edit)\r\n\r\n        self.openai_api_key_edit = QLineEdit()\r\n        self.openai_api_key_edit.setEchoMode(QLineEdit.EchoMode.Password)\r\n        backend_form.addRow(\"OpenAI API key:\", self.openai_api_key_edit)\r\n\r\n        self.openai_base_url_edit = QLineEdit()\r\n        backend_form.addRow(\"OpenAI Base URL:\", self.openai_base_url_edit)\r\n\r\n        layout.addWidget(backend_group)\r\n\r\n        # === Блок: модели распознавания (ASR) ==================================\r\n        asr_group = QGroupBox(\"Модели распознавания (ASR)\")\r\n        asr_form = QFormLayout(asr_group)\r\n\r\n        self.groq_asr_model_edit = QLineEdit()\r\n        asr_form.addRow(\"Groq ASR model:\", self.groq_asr_model_edit)\r\n\r\n        self.openai_asr_model_edit = QLineEdit()\r\n        asr_form.addRow(\"OpenAI ASR model:\", self.openai_asr_model_edit)\r\n\r\n        # Локальный GigaAM-v3 (модель и HF‑токен)\r\n        self.gigaam_model_edit = QLineEdit()\r\n        asr_form.addRow(\"GigaAM-v3 local model:\", self.gigaam_model_edit)\r\n\r\n        self.gigaam_hf_token_edit = QLineEdit()\r\n        self.gigaam_hf_token_edit.setEchoMode(QLineEdit.EchoMode.Password)\r\n        self.gigaam_hf_token_edit.setPlaceholderText(\r\n            \"Hugging Face token для GigaAM‑v3 (нужен для длинных записей)\"\r\n        )\r\n        asr_form.addRow(\"HF token (GigaAM):\", self.gigaam_hf_token_edit)\r\n\r\n        layout.addWidget(asr_group)\r\n\r\n        # === Блок: постобработка (LLM) =========================================\r\n        post_group = QGroupBox(\"Постобработка текста (LLM)\")\r\n        post_form = QFormLayout(post_group)\r\n\r\n        self.post_enabled_checkbox = QCheckBox(\"Включить постпроцессинг\")\r\n        post_form.addRow(self.post_enabled_checkbox)\r\n\r\n        # выбор backend для постпроцессинга (независимо от backend'а распознавания)\r\n        self.post_backend_combo = QComboBox()\r\n        self.post_backend_combo.addItem(\"Groq\", userData=\"groq\")\r\n        self.post_backend_combo.addItem(\"OpenAI\", userData=\"openai\")\r\n        post_form.addRow(\"Сервис постпроцессинга:\", self.post_backend_combo)\r\n\r\n        self.groq_llm_model_edit = QLineEdit()\r\n        post_form.addRow(\"Groq postprocess model:\", self.groq_llm_model_edit)\r\n\r\n        self.openai_llm_model_edit = QLineEdit()\r\n        post_form.addRow(\"OpenAI postprocess model:\", self.openai_llm_model_edit)\r\n\r\n        layout.addWidget(post_group)\r\n\r\n        # === Кнопки ============================================================\r\n        buttons = QDialogButtonBox(\r\n            QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel\r\n        )\r\n        buttons.accepted.connect(self._on_accept)\r\n        buttons.rejected.connect(self.reject)\r\n        layout.addWidget(buttons)\r\n\r\n        self.setLayout(layout)\r\n        self.setMinimumWidth(600)\r\n        self.setMinimumHeight(400)\r\n\r\n    # ------------------------------------------------------------------ load/save\r\n\r\n    def _load_from_settings(self, settings: AppSettings) -> None:\r\n        rec: RecognitionConfig = settings.recognition\r\n\r\n        # backend\r\n        backend = (rec.backend or \"groq\").lower()\r\n        index = self.backend_combo.findData(backend)\r\n        if index == -1:\r\n            index = self.backend_combo.findData(\"groq\")\r\n        if index != -1:\r\n            self.backend_combo.setCurrentIndex(index)\r\n\r\n        # ключи / URL\r\n        self.groq_api_key_edit.setText(rec.groq.api_key)\r\n        self.openai_api_key_edit.setText(rec.openai.api_key)\r\n        self.openai_base_url_edit.setText(rec.openai.base_url)\r\n\r\n        # ASR‑модели\r\n        self.groq_asr_model_edit.setText(rec.groq.model)\r\n        self.openai_asr_model_edit.setText(rec.openai.model)\r\n        self.gigaam_model_edit.setText(rec.local.model)\r\n        self.gigaam_hf_token_edit.setText(getattr(rec.local, \"hf_token\", \"\") or \"\")\r\n\r\n        # LLM‑модели (постпроцессинг)\r\n        self.post_enabled_checkbox.setChecked(settings.postprocess.enabled)\r\n\r\n        # backend постпроцессинга (llm_backend)\r\n        llm_backend = (settings.postprocess.llm_backend or \"groq\").lower()\r\n        idx_llm = (\r\n            self.post_backend_combo.findData(llm_backend)\r\n            if llm_backend in (\"groq\", \"openai\")\r\n            else -1\r\n        )\r\n        if idx_llm == -1:\r\n            idx_llm = self.post_backend_combo.findData(\"groq\")\r\n        if idx_llm != -1:\r\n            self.post_backend_combo.setCurrentIndex(idx_llm)\r\n\r\n        # Модели LLM берём из recognition.*.model_process — это единственный источник правды.\r\n        self.groq_llm_model_edit.setText(settings.recognition.groq.model_process)\r\n        self.openai_llm_model_edit.setText(settings.recognition.openai.model_process)\r\n\r\n        # раньше здесь вызывался _on_backend_changed(), который скрывал поля ключей.\r\n        # теперь все поля всегда видимы, поэтому вызов не нужен.\r\n        # self._on_backend_changed()\r\n\r\n    def _build_new_settings(self) -> AppSettings:\r\n        backend_data = self.backend_combo.currentData()\r\n        backend = str(backend_data) if backend_data is not None else \"groq\"\r\n\r\n        old = self._original_settings\r\n\r\n        groq_asr_model = self.groq_asr_model_edit.text().strip()\r\n        openai_asr_model = self.openai_asr_model_edit.text().strip()\r\n\r\n        groq_llm_model = self.groq_llm_model_edit.text().strip()\r\n        openai_llm_model = self.openai_llm_model_edit.text().strip()\r\n\r\n        # Обновляем recognition:\r\n        # - ASR‑модели (model) берём из полей ASR.\r\n        # - LLM‑модели для постпроцессинга:\r\n        #     * Groq: пишем в recognition.groq.model_process\r\n        #     * OpenAI: пишем в recognition.openai.model_process\r\n        new_recognition = RecognitionConfig(\r\n            backend=backend,\r\n            local=replace(\r\n                old.recognition.local,\r\n                model=(self.gigaam_model_edit.text().strip() or old.recognition.local.model),\r\n                hf_token=self.gigaam_hf_token_edit.text().strip(),\r\n            ),\r\n            openai=replace(\r\n                old.recognition.openai,\r\n                api_key=self.openai_api_key_edit.text().strip(),\r\n                base_url=self.openai_base_url_edit.text().strip(),\r\n                model=openai_asr_model or old.recognition.openai.model,\r\n                model_process=openai_llm_model or old.recognition.openai.model_process,\r\n            ),\r\n            groq=replace(\r\n                old.recognition.groq,\r\n                api_key=self.groq_api_key_edit.text().strip(),\r\n                model=groq_asr_model or old.recognition.groq.model,\r\n                model_process=groq_llm_model or old.recognition.groq.model_process,\r\n            ),\r\n        )\r\n\r\n        # Блок postprocess больше не является источником правды для моделей LLM.\r\n        # Держим его только как \"отображение\" текущих значений (для обратной совместимости),\r\n        # но в рантайме TextPostprocessor берёт модели из recognition.*.model_process.\r\n        new_postprocess = replace(\r\n            old.postprocess,\r\n            enabled=self.post_enabled_checkbox.isChecked(),\r\n            llm_backend=str(\r\n                self.post_backend_combo.currentData()\r\n                or old.postprocess.llm_backend\r\n                or \"groq\"\r\n            ),\r\n            groq=replace(\r\n                old.postprocess.groq,\r\n                model=groq_llm_model or old.postprocess.groq.model,\r\n            ),\r\n            openai=replace(\r\n                old.postprocess.openai,\r\n                model=openai_llm_model or old.postprocess.openai.model,\r\n            ),\r\n        )\r\n\r\n        return replace(\r\n            old,\r\n            recognition=new_recognition,\r\n            postprocess=new_postprocess,\r\n        )\r\n\r\n    # ------------------------------------------------------------------ slots\r\n\r\n    def _on_backend_changed(self) -> None:\r\n        backend_data = self.backend_combo.currentData()\r\n        backend = str(backend_data) if backend_data is not None else \"groq\"\r\n\r\n        is_groq = backend == \"groq\"\r\n        is_openai = backend == \"openai\"\r\n\r\n        # Groq поля видимы только при Groq backend\r\n        self.groq_api_key_edit.setVisible(is_groq)\r\n\r\n        # OpenAI поля видимы только при OpenAI backend\r\n        self.openai_api_key_edit.setVisible(is_openai)\r\n        self.openai_base_url_edit.setVisible(is_openai)\r\n\r\n    def _on_accept(self) -> None:\r\n        self._result_settings = self._build_new_settings()\r\n        self.accept()"
        }
    ]
}