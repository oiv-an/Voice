{
    "sourceFile": "src/config/settings.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1764627897055,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764647635292,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,4 @@\n-from __future__ import annotations\r\n \r\n from dataclasses import dataclass, field\r\n from pathlib import Path\r\n from typing import Any, Dict\r\n"
                },
                {
                    "date": 1764647755641,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,5 @@\n+from __future__ import annotations\r\n \r\n from dataclasses import dataclass, field\r\n from pathlib import Path\r\n from typing import Any, Dict\r\n@@ -32,9 +33,9 @@\n     device: str | int = \"default\"\r\n     sample_rate: int = 16000\r\n     channels: int = 1\r\n     format: str = \"float32\"\r\n-    max_duration: int = 60\r\n+    max_duration: int = 25\r\n     vad_threshold: float = 0.5\r\n     vad_min_duration: float = 0.1\r\n \r\n \r\n@@ -45,9 +46,8 @@\n     compute_type: str = \"float16\"\r\n     language: str = \"ru\"\r\n     beam_size: int = 5\r\n     temperature: float = 0.0\r\n-    hf_token: str = \"\"\r\n \r\n \r\n @dataclass\r\n class OpenAIRecognitionConfig:\r\n"
                },
                {
                    "date": 1764671742247,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,9 +33,9 @@\n     device: str | int = \"default\"\r\n     sample_rate: int = 16000\r\n     channels: int = 1\r\n     format: str = \"float32\"\r\n-    max_duration: int = 25\r\n+    max_duration: int = 60\r\n     vad_threshold: float = 0.5\r\n     vad_min_duration: float = 0.1\r\n \r\n \r\n@@ -212,8 +212,12 @@\n         local_raw_rec = rec_raw.get(\"local\", {}) or {}\r\n         openai_raw_rec = rec_raw.get(\"openai\", {}) or {}\r\n         groq_raw_rec = rec_raw.get(\"groq\", {}) or {}\r\n \r\n+        # Удаляем устаревшее поле hf_token из локального блока, если оно есть в старом config.yaml\r\n+        if \"hf_token\" in local_raw_rec:\r\n+            local_raw_rec.pop(\"hf_token\", None)\r\n+\r\n         recognition_cfg = RecognitionConfig(\r\n             backend=rec_raw.get(\"backend\", \"local\"),\r\n             local=LocalRecognitionConfig(\r\n                 **{**LocalRecognitionConfig().__dict__, **local_raw_rec}\r\n"
                },
                {
                    "date": 1764806743671,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,8 +22,9 @@\n \r\n @dataclass\r\n class HotkeysConfig:\r\n     record: str = \"ctrl+win\"\r\n+    record_idea: str = \"ctrl+win+alt\"\r\n     cancel: str = \"esc\"\r\n     toggle_window: str = \"ctrl+alt+s\"\r\n     toggle_debug: str = \"ctrl+alt+d\"\r\n \r\n"
                },
                {
                    "date": 1764807682343,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,324 @@\n+from __future__ import annotations\r\n+\r\n+from dataclasses import dataclass, field\r\n+from pathlib import Path\r\n+from typing import Any, Dict\r\n+\r\n+import yaml\r\n+\r\n+\r\n+# ---------------------------------------------------------------------------#\r\n+# Dataclasses for structured settings\r\n+# ---------------------------------------------------------------------------#\r\n+\r\n+\r\n+@dataclass\r\n+class AppInfoConfig:\r\n+    name: str = \"VoiceCapture\"\r\n+    version: str = \"1.1.0\"\r\n+    language: str = \"ru\"\r\n+    debug: bool = False\r\n+\r\n+\r\n+@dataclass\r\n+class HotkeysConfig:\r\n+    record: str = \"ctrl+win\"\r\n+    record_idea: str = \"ctrl+win+alt\"\r\n+    cancel: str = \"esc\"\r\n+    toggle_window: str = \"ctrl+alt+s\"\r\n+    toggle_debug: str = \"ctrl+alt+d\"\r\n+\r\n+\r\n+@dataclass\r\n+class AudioConfig:\r\n+    device: str | int = \"default\"\r\n+    sample_rate: int = 16000\r\n+    channels: int = 1\r\n+    format: str = \"float32\"\r\n+    max_duration: int = 60\r\n+    vad_threshold: float = 0.5\r\n+    vad_min_duration: float = 0.1\r\n+\r\n+\r\n+@dataclass\r\n+class LocalRecognitionConfig:\r\n+    model: str = \"large-v3\"\r\n+    device: str = \"cuda\"\r\n+    compute_type: str = \"float16\"\r\n+    language: str = \"ru\"\r\n+    beam_size: int = 5\r\n+    temperature: float = 0.0\r\n+\r\n+\r\n+@dataclass\r\n+class OpenAIRecognitionConfig:\r\n+    api_key: str = \"sk-...\"\r\n+    model: str = \"whisper-1\"\r\n+    # Модель для постобработки текста (LLM), чтобы не плодить отдельные блоки.\r\n+    model_process: str = \"gpt-5.1\"\r\n+    language: str = \"ru\"\r\n+    base_url: str = \"\"  # URL всегда задаётся только в config.yaml / настройках\r\n+\r\n+\r\n+@dataclass\r\n+class GroqRecognitionConfig:\r\n+    api_key: str = \"gsk-...\"\r\n+    model: str = \"whisper-large-v3\"\r\n+    # Модель для постобработки текста (LLM) — одно поле рядом с моделью распознавания.\r\n+    model_process: str = \"moonshotai/kimi-k2-instruct\"\r\n+    language: str = \"ru\"\r\n+\r\n+\r\n+from dataclasses import dataclass, field\r\n+...\r\n+@dataclass\r\n+class RecognitionConfig:\r\n+    backend: str = \"local\"  # local, openai, groq\r\n+    local: LocalRecognitionConfig = field(default_factory=LocalRecognitionConfig)\r\n+    openai: OpenAIRecognitionConfig = field(default_factory=OpenAIRecognitionConfig)\r\n+    groq: GroqRecognitionConfig = field(default_factory=GroqRecognitionConfig)\r\n+\r\n+\r\n+# Блоки постпроцессинга больше не хранят свои ключи — только для обратной\r\n+# совместимости структуры. Модели LLM берём из recognition.*.model_process.\r\n+@dataclass\r\n+class GroqPostprocessConfig:\r\n+    model: str = \"moonshotai/kimi-k2-instruct\"\r\n+\r\n+\r\n+@dataclass\r\n+class OpenAIPostprocessConfig:\r\n+    model: str = \"gpt-5.1\"\r\n+\r\n+\r\n+@dataclass\r\n+class PostprocessConfig:\r\n+    enabled: bool = True\r\n+    mode: str = \"llm\"  # simple, llm\r\n+    llm_backend: str = \"groq\"  # groq, openai\r\n+    groq: GroqPostprocessConfig = field(default_factory=GroqPostprocessConfig)\r\n+    openai: OpenAIPostprocessConfig = field(default_factory=OpenAIPostprocessConfig)\r\n+\r\n+\r\n+@dataclass\r\n+class UIConfig:\r\n+    always_on_top: bool = True\r\n+    opacity: float = 0.8\r\n+    # Дефолтный размер окна: 600x500\r\n+    window_size: tuple[int, int] = (600, 500)\r\n+    auto_hide_after_paste: bool = True\r\n+    hide_delay: int = 2000  # ms\r\n+\r\n+\r\n+@dataclass\r\n+class LoggingConfig:\r\n+    level: str = \"INFO\"\r\n+    file: str = \"app.log\"\r\n+    max_file_size: int = 10 * 1024 * 1024\r\n+    backup_count: int = 3\r\n+\r\n+\r\n+@dataclass\r\n+class AppSettings:\r\n+    app: AppInfoConfig\r\n+    hotkeys: HotkeysConfig\r\n+    audio: AudioConfig\r\n+    recognition: RecognitionConfig\r\n+    postprocess: PostprocessConfig\r\n+    ui: UIConfig\r\n+    logging: LoggingConfig\r\n+\r\n+    # ------------------------------------------------------------------ factory\r\n+\r\n+    @classmethod\r\n+    def load_default(cls) -> \"AppSettings\":\r\n+        \"\"\"\r\n+        Единая загрузка настроек из ОДНОГО файла config.yaml.\r\n+\r\n+        Логика:\r\n+\r\n+        1. Определяем base_dir:\r\n+           - если PyInstaller EXE: папка exe;\r\n+           - иначе: корень проекта (двумя уровнями выше этого файла).\r\n+\r\n+        2. Файл настроек: base_dir/config.yaml\r\n+           - если файла нет — создаём его с дефолтами из датаклассов.\r\n+\r\n+        3. Загружаем config.yaml и маппим в AppSettings.\r\n+        \"\"\"\r\n+        import sys\r\n+\r\n+        if getattr(sys, \"frozen\", False):\r\n+            base_dir = Path(sys.executable).resolve().parent\r\n+        else:\r\n+            base_dir = Path(__file__).resolve().parents[2]\r\n+\r\n+        config_path = base_dir / \"config.yaml\"\r\n+\r\n+        # Если файла нет — создаём дефолтный config.yaml\r\n+        if not config_path.exists():\r\n+            default = {\r\n+                \"app\": AppInfoConfig().__dict__,\r\n+                \"hotkeys\": HotkeysConfig().__dict__,\r\n+                \"audio\": AudioConfig().__dict__,\r\n+                \"recognition\": {\r\n+                    \"backend\": RecognitionConfig().backend,\r\n+                    \"local\": LocalRecognitionConfig().__dict__,\r\n+                    \"openai\": OpenAIRecognitionConfig().__dict__,\r\n+                    \"groq\": GroqRecognitionConfig().__dict__,\r\n+                },\r\n+                \"postprocess\": {\r\n+                    \"enabled\": PostprocessConfig().enabled,\r\n+                    \"mode\": PostprocessConfig().mode,\r\n+                    \"llm_backend\": PostprocessConfig().llm_backend,\r\n+                    \"groq\": {\"model\": GroqPostprocessConfig().model},\r\n+                    \"openai\": {\r\n+                        \"model\": OpenAIPostprocessConfig().model,\r\n+                    },\r\n+                },\r\n+                \"ui\": UIConfig().__dict__,\r\n+                \"logging\": LoggingConfig().__dict__,\r\n+            }\r\n+            try:\r\n+                with config_path.open(\"w\", encoding=\"utf-8\") as f:\r\n+                    yaml.safe_dump(default, f, allow_unicode=True, sort_keys=False)\r\n+            except Exception:\r\n+                # Если не удалось записать файл — просто вернём дефолтные настройки\r\n+                return cls(\r\n+                    app=AppInfoConfig(),\r\n+                    hotkeys=HotkeysConfig(),\r\n+                    audio=AudioConfig(),\r\n+                    recognition=RecognitionConfig(),\r\n+                    postprocess=PostprocessConfig(),\r\n+                    ui=UIConfig(),\r\n+                    logging=LoggingConfig(),\r\n+                )\r\n+\r\n+        with config_path.open(\"r\", encoding=\"utf-8\") as f:\r\n+            raw: Dict[str, Any] = yaml.safe_load(f) or {}\r\n+\r\n+        def get_section(name: str, default: Dict[str, Any]) -> Dict[str, Any]:\r\n+            section = raw.get(name, {}) or {}\r\n+            # Shallow-merge section over defaults so that missing keys\r\n+            # still get dataclass defaults.\r\n+            merged: Dict[str, Any] = dict(default)\r\n+            merged.update(section)\r\n+            return merged\r\n+\r\n+        app_cfg = AppInfoConfig(**get_section(\"app\", AppInfoConfig().__dict__))\r\n+        hotkeys_cfg = HotkeysConfig(**get_section(\"hotkeys\", HotkeysConfig().__dict__))\r\n+        audio_cfg = AudioConfig(**get_section(\"audio\", AudioConfig().__dict__))\r\n+\r\n+        rec_raw = raw.get(\"recognition\", {}) or {}\r\n+        local_raw_rec = rec_raw.get(\"local\", {}) or {}\r\n+        openai_raw_rec = rec_raw.get(\"openai\", {}) or {}\r\n+        groq_raw_rec = rec_raw.get(\"groq\", {}) or {}\r\n+\r\n+        # Удаляем устаревшее поле hf_token из локального блока, если оно есть в старом config.yaml\r\n+        if \"hf_token\" in local_raw_rec:\r\n+            local_raw_rec.pop(\"hf_token\", None)\r\n+\r\n+        recognition_cfg = RecognitionConfig(\r\n+            backend=rec_raw.get(\"backend\", \"local\"),\r\n+            local=LocalRecognitionConfig(\r\n+                **{**LocalRecognitionConfig().__dict__, **local_raw_rec}\r\n+            ),\r\n+            openai=OpenAIRecognitionConfig(\r\n+                **{**OpenAIRecognitionConfig().__dict__, **openai_raw_rec}\r\n+            ),\r\n+            groq=GroqRecognitionConfig(\r\n+                **{**GroqRecognitionConfig().__dict__, **groq_raw_rec}\r\n+            ),\r\n+        )\r\n+\r\n+        post_raw = raw.get(\"postprocess\", {}) or {}\r\n+        groq_post_raw = post_raw.get(\"groq\", {}) or {}\r\n+        openai_post_raw = post_raw.get(\"openai\", {}) or {}\r\n+\r\n+        # Старые поля api_key/model/model_process/base_url в postprocess.* игнорируем —\r\n+        # ключи, модели и URL живут в recognition.*.\r\n+        for k in (\"api_key\", \"model\", \"model_process\", \"base_url\"):\r\n+            if k in groq_post_raw:\r\n+                groq_post_raw.pop(k, None)\r\n+            if k in openai_post_raw:\r\n+                openai_post_raw.pop(k, None)\r\n+\r\n+        postprocess_cfg = PostprocessConfig(\r\n+            enabled=post_raw.get(\"enabled\", True),\r\n+            mode=post_raw.get(\"mode\", \"llm\"),\r\n+            llm_backend=post_raw.get(\"llm_backend\", \"groq\"),\r\n+            groq=GroqPostprocessConfig(\r\n+                **{**GroqPostprocessConfig().__dict__, **groq_post_raw}\r\n+            ),\r\n+            openai=OpenAIPostprocessConfig(\r\n+                **{**OpenAIPostprocessConfig().__dict__, **openai_post_raw}\r\n+            ),\r\n+        )\r\n+\r\n+        # UI: дополнительно фильтруем устаревшие/лишние поля (width/height/compact_mode)\r\n+        ui_raw = get_section(\"ui\", UIConfig().__dict__)\r\n+        for k in (\"width\", \"height\", \"compact_mode\"):\r\n+            ui_raw.pop(k, None)\r\n+        ui_cfg = UIConfig(**ui_raw)\r\n+\r\n+        # Logging: фильтруем устаревшие поля (log_dir и т.п.), чтобы не падать\r\n+        logging_raw = get_section(\"logging\", LoggingConfig().__dict__)\r\n+        for k in (\"log_dir\",):\r\n+            logging_raw.pop(k, None)\r\n+        logging_cfg = LoggingConfig(**logging_raw)\r\n+\r\n+        return cls(\r\n+            app=app_cfg,\r\n+            hotkeys=hotkeys_cfg,\r\n+            audio=audio_cfg,\r\n+            recognition=recognition_cfg,\r\n+            postprocess=postprocess_cfg,\r\n+            ui=ui_cfg,\r\n+            logging=logging_cfg,\r\n+        )\r\n+\r\n+    # ------------------------------------------------------------------ save\r\n+\r\n+    @classmethod\r\n+    def save_default(cls, settings: \"AppSettings\") -> None:\r\n+        \"\"\"\r\n+        Сохранить ВСЕ текущие настройки в ОДИН файл config.yaml в base_dir.\r\n+\r\n+        - Тот же base_dir, что и в load_default().\r\n+        - Никаких config.local.yaml, никаких src/config/config.yaml.\r\n+        - Этот файл должен быть добавлен в .gitignore и не коммититься.\r\n+        \"\"\"\r\n+        import sys\r\n+\r\n+        if getattr(sys, \"frozen\", False):\r\n+            base_dir = Path(sys.executable).resolve().parent\r\n+        else:\r\n+            base_dir = Path(__file__).resolve().parents[2]\r\n+\r\n+        config_path = base_dir / \"config.yaml\"\r\n+\r\n+        data: Dict[str, Any] = {\r\n+            \"app\": settings.app.__dict__,\r\n+            \"hotkeys\": settings.hotkeys.__dict__,\r\n+            \"audio\": settings.audio.__dict__,\r\n+            \"recognition\": {\r\n+                \"backend\": settings.recognition.backend,\r\n+                \"local\": settings.recognition.local.__dict__,\r\n+                \"openai\": settings.recognition.openai.__dict__,\r\n+                \"groq\": settings.recognition.groq.__dict__,\r\n+            },\r\n+            \"postprocess\": {\r\n+                \"enabled\": settings.postprocess.enabled,\r\n+                \"mode\": settings.postprocess.mode,\r\n+                \"llm_backend\": settings.postprocess.llm_backend,\r\n+                \"groq\": {\"model\": settings.postprocess.groq.model},\r\n+                \"openai\": {\r\n+                    \"model\": settings.postprocess.openai.model,\r\n+                },\r\n+            },\r\n+            \"ui\": settings.ui.__dict__,\r\n+            \"logging\": settings.logging.__dict__,\r\n+        }\r\n+\r\n+        with config_path.open(\"w\", encoding=\"utf-8\") as f:\r\n+            yaml.safe_dump(data, f, allow_unicode=True, sort_keys=False)\n\\ No newline at end of file\n"
                }
            ],
            "date": 1764627897055,
            "name": "Commit-0",
            "content": "from __future__ import annotations\r\n\r\nfrom dataclasses import dataclass, field\r\nfrom pathlib import Path\r\nfrom typing import Any, Dict\r\n\r\nimport yaml\r\n\r\n\r\n# ---------------------------------------------------------------------------#\r\n# Dataclasses for structured settings\r\n# ---------------------------------------------------------------------------#\r\n\r\n\r\n@dataclass\r\nclass AppInfoConfig:\r\n    name: str = \"VoiceCapture\"\r\n    version: str = \"1.0.0\"\r\n    language: str = \"ru\"\r\n    debug: bool = False\r\n\r\n\r\n@dataclass\r\nclass HotkeysConfig:\r\n    record: str = \"ctrl+win\"\r\n    cancel: str = \"esc\"\r\n    toggle_window: str = \"ctrl+alt+s\"\r\n    toggle_debug: str = \"ctrl+alt+d\"\r\n\r\n\r\n@dataclass\r\nclass AudioConfig:\r\n    device: str | int = \"default\"\r\n    sample_rate: int = 16000\r\n    channels: int = 1\r\n    format: str = \"float32\"\r\n    max_duration: int = 60\r\n    vad_threshold: float = 0.5\r\n    vad_min_duration: float = 0.1\r\n\r\n\r\n@dataclass\r\nclass LocalRecognitionConfig:\r\n    model: str = \"large-v3\"\r\n    device: str = \"cuda\"\r\n    compute_type: str = \"float16\"\r\n    language: str = \"ru\"\r\n    beam_size: int = 5\r\n    temperature: float = 0.0\r\n    hf_token: str = \"\"\r\n\r\n\r\n@dataclass\r\nclass OpenAIRecognitionConfig:\r\n    api_key: str = \"sk-...\"\r\n    model: str = \"whisper-1\"\r\n    # Модель для постобработки текста (LLM), чтобы не плодить отдельные блоки.\r\n    model_process: str = \"gpt-5.1\"\r\n    language: str = \"ru\"\r\n    base_url: str = \"\"  # URL всегда задаётся только в config.yaml / настройках\r\n\r\n\r\n@dataclass\r\nclass GroqRecognitionConfig:\r\n    api_key: str = \"gsk-...\"\r\n    model: str = \"whisper-large-v3\"\r\n    # Модель для постобработки текста (LLM) — одно поле рядом с моделью распознавания.\r\n    model_process: str = \"moonshotai/kimi-k2-instruct\"\r\n    language: str = \"ru\"\r\n\r\n\r\nfrom dataclasses import dataclass, field\r\n...\r\n@dataclass\r\nclass RecognitionConfig:\r\n    backend: str = \"local\"  # local, openai, groq\r\n    local: LocalRecognitionConfig = field(default_factory=LocalRecognitionConfig)\r\n    openai: OpenAIRecognitionConfig = field(default_factory=OpenAIRecognitionConfig)\r\n    groq: GroqRecognitionConfig = field(default_factory=GroqRecognitionConfig)\r\n\r\n\r\n# Блоки постпроцессинга больше не хранят свои ключи — только для обратной\r\n# совместимости структуры. Модели LLM берём из recognition.*.model_process.\r\n@dataclass\r\nclass GroqPostprocessConfig:\r\n    model: str = \"moonshotai/kimi-k2-instruct\"\r\n\r\n\r\n@dataclass\r\nclass OpenAIPostprocessConfig:\r\n    model: str = \"gpt-5.1\"\r\n\r\n\r\n@dataclass\r\nclass PostprocessConfig:\r\n    enabled: bool = True\r\n    mode: str = \"llm\"  # simple, llm\r\n    llm_backend: str = \"groq\"  # groq, openai\r\n    groq: GroqPostprocessConfig = field(default_factory=GroqPostprocessConfig)\r\n    openai: OpenAIPostprocessConfig = field(default_factory=OpenAIPostprocessConfig)\r\n\r\n\r\n@dataclass\r\nclass UIConfig:\r\n    always_on_top: bool = True\r\n    opacity: float = 0.8\r\n    # Дефолтный размер окна: 600x500\r\n    window_size: tuple[int, int] = (600, 500)\r\n    auto_hide_after_paste: bool = True\r\n    hide_delay: int = 2000  # ms\r\n\r\n\r\n@dataclass\r\nclass LoggingConfig:\r\n    level: str = \"INFO\"\r\n    file: str = \"app.log\"\r\n    max_file_size: int = 10 * 1024 * 1024\r\n    backup_count: int = 3\r\n\r\n\r\n@dataclass\r\nclass AppSettings:\r\n    app: AppInfoConfig\r\n    hotkeys: HotkeysConfig\r\n    audio: AudioConfig\r\n    recognition: RecognitionConfig\r\n    postprocess: PostprocessConfig\r\n    ui: UIConfig\r\n    logging: LoggingConfig\r\n\r\n    # ------------------------------------------------------------------ factory\r\n\r\n    @classmethod\r\n    def load_default(cls) -> \"AppSettings\":\r\n        \"\"\"\r\n        Единая загрузка настроек из ОДНОГО файла config.yaml.\r\n\r\n        Логика:\r\n\r\n        1. Определяем base_dir:\r\n           - если PyInstaller EXE: папка exe;\r\n           - иначе: корень проекта (двумя уровнями выше этого файла).\r\n\r\n        2. Файл настроек: base_dir/config.yaml\r\n           - если файла нет — создаём его с дефолтами из датаклассов.\r\n\r\n        3. Загружаем config.yaml и маппим в AppSettings.\r\n        \"\"\"\r\n        import sys\r\n\r\n        if getattr(sys, \"frozen\", False):\r\n            base_dir = Path(sys.executable).resolve().parent\r\n        else:\r\n            base_dir = Path(__file__).resolve().parents[2]\r\n\r\n        config_path = base_dir / \"config.yaml\"\r\n\r\n        # Если файла нет — создаём дефолтный config.yaml\r\n        if not config_path.exists():\r\n            default = {\r\n                \"app\": AppInfoConfig().__dict__,\r\n                \"hotkeys\": HotkeysConfig().__dict__,\r\n                \"audio\": AudioConfig().__dict__,\r\n                \"recognition\": {\r\n                    \"backend\": RecognitionConfig().backend,\r\n                    \"local\": LocalRecognitionConfig().__dict__,\r\n                    \"openai\": OpenAIRecognitionConfig().__dict__,\r\n                    \"groq\": GroqRecognitionConfig().__dict__,\r\n                },\r\n                \"postprocess\": {\r\n                    \"enabled\": PostprocessConfig().enabled,\r\n                    \"mode\": PostprocessConfig().mode,\r\n                    \"llm_backend\": PostprocessConfig().llm_backend,\r\n                    \"groq\": {\"model\": GroqPostprocessConfig().model},\r\n                    \"openai\": {\r\n                        \"model\": OpenAIPostprocessConfig().model,\r\n                    },\r\n                },\r\n                \"ui\": UIConfig().__dict__,\r\n                \"logging\": LoggingConfig().__dict__,\r\n            }\r\n            try:\r\n                with config_path.open(\"w\", encoding=\"utf-8\") as f:\r\n                    yaml.safe_dump(default, f, allow_unicode=True, sort_keys=False)\r\n            except Exception:\r\n                # Если не удалось записать файл — просто вернём дефолтные настройки\r\n                return cls(\r\n                    app=AppInfoConfig(),\r\n                    hotkeys=HotkeysConfig(),\r\n                    audio=AudioConfig(),\r\n                    recognition=RecognitionConfig(),\r\n                    postprocess=PostprocessConfig(),\r\n                    ui=UIConfig(),\r\n                    logging=LoggingConfig(),\r\n                )\r\n\r\n        with config_path.open(\"r\", encoding=\"utf-8\") as f:\r\n            raw: Dict[str, Any] = yaml.safe_load(f) or {}\r\n\r\n        def get_section(name: str, default: Dict[str, Any]) -> Dict[str, Any]:\r\n            section = raw.get(name, {}) or {}\r\n            # Shallow-merge section over defaults so that missing keys\r\n            # still get dataclass defaults.\r\n            merged: Dict[str, Any] = dict(default)\r\n            merged.update(section)\r\n            return merged\r\n\r\n        app_cfg = AppInfoConfig(**get_section(\"app\", AppInfoConfig().__dict__))\r\n        hotkeys_cfg = HotkeysConfig(**get_section(\"hotkeys\", HotkeysConfig().__dict__))\r\n        audio_cfg = AudioConfig(**get_section(\"audio\", AudioConfig().__dict__))\r\n\r\n        rec_raw = raw.get(\"recognition\", {}) or {}\r\n        local_raw_rec = rec_raw.get(\"local\", {}) or {}\r\n        openai_raw_rec = rec_raw.get(\"openai\", {}) or {}\r\n        groq_raw_rec = rec_raw.get(\"groq\", {}) or {}\r\n\r\n        recognition_cfg = RecognitionConfig(\r\n            backend=rec_raw.get(\"backend\", \"local\"),\r\n            local=LocalRecognitionConfig(\r\n                **{**LocalRecognitionConfig().__dict__, **local_raw_rec}\r\n            ),\r\n            openai=OpenAIRecognitionConfig(\r\n                **{**OpenAIRecognitionConfig().__dict__, **openai_raw_rec}\r\n            ),\r\n            groq=GroqRecognitionConfig(\r\n                **{**GroqRecognitionConfig().__dict__, **groq_raw_rec}\r\n            ),\r\n        )\r\n\r\n        post_raw = raw.get(\"postprocess\", {}) or {}\r\n        groq_post_raw = post_raw.get(\"groq\", {}) or {}\r\n        openai_post_raw = post_raw.get(\"openai\", {}) or {}\r\n\r\n        # Старые поля api_key/model/model_process/base_url в postprocess.* игнорируем —\r\n        # ключи, модели и URL живут в recognition.*.\r\n        for k in (\"api_key\", \"model\", \"model_process\", \"base_url\"):\r\n            if k in groq_post_raw:\r\n                groq_post_raw.pop(k, None)\r\n            if k in openai_post_raw:\r\n                openai_post_raw.pop(k, None)\r\n\r\n        postprocess_cfg = PostprocessConfig(\r\n            enabled=post_raw.get(\"enabled\", True),\r\n            mode=post_raw.get(\"mode\", \"llm\"),\r\n            llm_backend=post_raw.get(\"llm_backend\", \"groq\"),\r\n            groq=GroqPostprocessConfig(\r\n                **{**GroqPostprocessConfig().__dict__, **groq_post_raw}\r\n            ),\r\n            openai=OpenAIPostprocessConfig(\r\n                **{**OpenAIPostprocessConfig().__dict__, **openai_post_raw}\r\n            ),\r\n        )\r\n\r\n        # UI: дополнительно фильтруем устаревшие/лишние поля (width/height/compact_mode)\r\n        ui_raw = get_section(\"ui\", UIConfig().__dict__)\r\n        for k in (\"width\", \"height\", \"compact_mode\"):\r\n            ui_raw.pop(k, None)\r\n        ui_cfg = UIConfig(**ui_raw)\r\n\r\n        # Logging: фильтруем устаревшие поля (log_dir и т.п.), чтобы не падать\r\n        logging_raw = get_section(\"logging\", LoggingConfig().__dict__)\r\n        for k in (\"log_dir\",):\r\n            logging_raw.pop(k, None)\r\n        logging_cfg = LoggingConfig(**logging_raw)\r\n\r\n        return cls(\r\n            app=app_cfg,\r\n            hotkeys=hotkeys_cfg,\r\n            audio=audio_cfg,\r\n            recognition=recognition_cfg,\r\n            postprocess=postprocess_cfg,\r\n            ui=ui_cfg,\r\n            logging=logging_cfg,\r\n        )\r\n\r\n    # ------------------------------------------------------------------ save\r\n\r\n    @classmethod\r\n    def save_default(cls, settings: \"AppSettings\") -> None:\r\n        \"\"\"\r\n        Сохранить ВСЕ текущие настройки в ОДИН файл config.yaml в base_dir.\r\n\r\n        - Тот же base_dir, что и в load_default().\r\n        - Никаких config.local.yaml, никаких src/config/config.yaml.\r\n        - Этот файл должен быть добавлен в .gitignore и не коммититься.\r\n        \"\"\"\r\n        import sys\r\n\r\n        if getattr(sys, \"frozen\", False):\r\n            base_dir = Path(sys.executable).resolve().parent\r\n        else:\r\n            base_dir = Path(__file__).resolve().parents[2]\r\n\r\n        config_path = base_dir / \"config.yaml\"\r\n\r\n        data: Dict[str, Any] = {\r\n            \"app\": settings.app.__dict__,\r\n            \"hotkeys\": settings.hotkeys.__dict__,\r\n            \"audio\": settings.audio.__dict__,\r\n            \"recognition\": {\r\n                \"backend\": settings.recognition.backend,\r\n                \"local\": settings.recognition.local.__dict__,\r\n                \"openai\": settings.recognition.openai.__dict__,\r\n                \"groq\": settings.recognition.groq.__dict__,\r\n            },\r\n            \"postprocess\": {\r\n                \"enabled\": settings.postprocess.enabled,\r\n                \"mode\": settings.postprocess.mode,\r\n                \"llm_backend\": settings.postprocess.llm_backend,\r\n                \"groq\": {\"model\": settings.postprocess.groq.model},\r\n                \"openai\": {\r\n                    \"model\": settings.postprocess.openai.model,\r\n                },\r\n            },\r\n            \"ui\": settings.ui.__dict__,\r\n            \"logging\": settings.logging.__dict__,\r\n        }\r\n\r\n        with config_path.open(\"w\", encoding=\"utf-8\") as f:\r\n            yaml.safe_dump(data, f, allow_unicode=True, sort_keys=False)"
        }
    ]
}